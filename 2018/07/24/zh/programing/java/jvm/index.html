<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>JVM - Zoctan&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Zoctan&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Zoctan&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Java 虚拟机（JVM） Java 源码，经过编译器编译后生成 .class 字节码文件：  Java 源码编译由以下三个过程组成：  分析和输入到符号表 注解处理 语义分析和生成class文件   JVM 将字节码文件翻译成特定平台下的机器码然后运行：   注：编译生成的是字节码，字节码不能直接运行，必须通过 JVM 翻译成机器码才能运行。不同平台下编译生成的字节码是一样的，但是由 JVM 翻"><meta property="og:type" content="blog"><meta property="og:title" content="JVM"><meta property="og:url" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/"><meta property="og:site_name" content="Zoctan&#039;s Blog"><meta property="og:description" content="Java 虚拟机（JVM） Java 源码，经过编译器编译后生成 .class 字节码文件：  Java 源码编译由以下三个过程组成：  分析和输入到符号表 注解处理 语义分析和生成class文件   JVM 将字节码文件翻译成特定平台下的机器码然后运行：   注：编译生成的是字节码，字节码不能直接运行，必须通过 JVM 翻译成机器码才能运行。不同平台下编译生成的字节码是一样的，但是由 JVM 翻"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/JVM.jpg"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E7%BC%96%E8%AF%91.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E5%AD%97%E8%8A%82%E7%A0%81%E7%BF%BB%E8%AF%91.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E8%BF%90%E8%A1%8C%E6%97%B6%E5%86%85%E5%AD%98%E5%88%92%E5%88%86.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E6%A0%88%E5%B8%A7.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E5%8F%A5%E6%9F%84%E8%AE%BF%E9%97%AE.png"><meta property="og:image" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E7%9B%B4%E6%8E%A5%E6%8C%87%E9%92%88%E8%AE%BF%E9%97%AE.png"><meta property="article:published_time" content="2018-07-23T16:00:00.000Z"><meta property="article:modified_time" content="2022-10-22T09:03:55.586Z"><meta property="article:author" content="Zoctan"><meta property="article:tag" content="zoctan,blog"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/JVM.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/"},"headline":"JVM","image":["https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/JVM.jpg","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E7%BC%96%E8%AF%91.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E5%AD%97%E8%8A%82%E7%A0%81%E7%BF%BB%E8%AF%91.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E8%BF%90%E8%A1%8C%E6%97%B6%E5%86%85%E5%AD%98%E5%88%92%E5%88%86.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E6%A0%88%E5%B8%A7.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E5%8F%A5%E6%9F%84%E8%AE%BF%E9%97%AE.png","https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E7%9B%B4%E6%8E%A5%E6%8C%87%E9%92%88%E8%AE%BF%E9%97%AE.png"],"datePublished":"2018-07-23T16:00:00.000Z","dateModified":"2022-10-22T09:03:55.586Z","author":{"@type":"Person","name":"Zoctan"},"publisher":{"@type":"Organization","name":"Zoctan's Blog","logo":{"@type":"ImageObject","url":"https://zoctan.github.io/img/logo.svg"}},"description":"Java 虚拟机（JVM） Java 源码，经过编译器编译后生成 .class 字节码文件：  Java 源码编译由以下三个过程组成：  分析和输入到符号表 注解处理 语义分析和生成class文件   JVM 将字节码文件翻译成特定平台下的机器码然后运行：   注：编译生成的是字节码，字节码不能直接运行，必须通过 JVM 翻译成机器码才能运行。不同平台下编译生成的字节码是一样的，但是由 JVM 翻"}</script><link rel="canonical" href="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/"><link rel="alternate" href="https://zoctan.github.io/atom.xml" title="Zoctan&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><meta name="msvalidate.01" content="3A666EB8EB887659AE5D32D988405EF2"><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-109619265-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-109619265-1")</script><script>!function(t,h,e,j,s,n){t.hj=t.hj||function(){(t.hj.q=t.hj.q||[]).push(arguments)},t._hjSettings={hjid:3209077,hjsv:6},s=h.getElementsByTagName("head")[0],(n=h.createElement("script")).async=1,n.src="https://static.hotjar.com/c/hotjar-"+t._hjSettings.hjid+".js?sv="+t._hjSettings.hjsv,s.appendChild(n)}(window,document)</script><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script data-ad-client="ca-pub-3229148200516708" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><script>(function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();</script><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Zoctan&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time datetime="2018-07-23T16:00:00.000Z" title="7/24/2018, 12:00:00 AM">2018-07-24</time></span><span class="level-item">Updated&nbsp;<time datetime="2022-10-22T09:03:55.586Z" title="10/22/2022, 5:03:55 PM">2022-10-22</time></span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a></span><span class="level-item">26 minutes read (About 3835 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">JVM</h1><div class="content"><h1 id="Java-虚拟机（JVM）"><a href="#Java-虚拟机（JVM）" class="headerlink" title="Java 虚拟机（JVM）"></a>Java 虚拟机（JVM）</h1><p><img src="/2018/07/24/zh/programing/java/jvm/JVM.jpg" alt="JVM" loading="lazy"></p><p>Java 源码，经过编译器编译后生成 .class 字节码文件：</p><p><img src="/2018/07/24/zh/programing/java/jvm/%E7%BC%96%E8%AF%91.png" alt="编译" loading="lazy"></p><p>Java 源码编译由以下三个过程组成：</p><ul><li>分析和输入到符号表</li><li>注解处理</li><li>语义分析和生成class文件</li></ul><p><img src="/2018/07/24/zh/programing/java/jvm/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91.png" alt="源码编译" loading="lazy"></p><p>JVM 将字节码文件翻译成特定平台下的机器码然后运行：</p><p><img src="/2018/07/24/zh/programing/java/jvm/%E5%AD%97%E8%8A%82%E7%A0%81%E7%BF%BB%E8%AF%91.png" alt="字节码翻译" loading="lazy"></p><blockquote><p>注：编译生成的是字节码，字节码不能直接运行，必须通过 JVM 翻译成机器码才能运行。不同平台下编译生成的字节码是一样的，但是由 JVM 翻译成的机器码却不一样。</p></blockquote><blockquote><p>注：跨平台的是 Java 程序，不是 JVM。JVM 是用 C&#x2F;C++ 开发的，不能跨平台，不同平台下需要安装不同版本的 JVM。</p></blockquote><span id="more"></span><h1 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a>内存区域</h1><p>根据《Java 虚拟机规范》，运行时数据区通常包括这几个部分：程序计数器、虚拟机栈、本地方法栈、堆区、方法区。</p><p><img src="/2018/07/24/zh/programing/java/jvm/%E8%BF%90%E8%A1%8C%E6%97%B6%E5%86%85%E5%AD%98%E5%88%92%E5%88%86.png" alt="JVM 运行时的内存划分" loading="lazy"></p><blockquote><p>规范中虽然规定了程序在执行期间运行时数据区应该包括这几部分，但是至于具体如何实现并没有做出规定，不同的虚拟机厂商可以有不同的实现方式。</p></blockquote><h2 id="程序计数器（Program-Counter-Register）"><a href="#程序计数器（Program-Counter-Register）" class="headerlink" title="程序计数器（Program Counter Register）"></a>程序计数器（Program Counter Register）</h2><p>程序计数器是一个比较小的内存区域，作用：指示当前线程所执行的字节码执行到了第几行。字节码解释器在工作时，会通过改变这个计数器的值来取下一条语句指令。</p><p>在 JVM 中，多线程是通过线程轮流切换来获得CPU执行时间的，所以在任一具体时刻，一个CPU的内核只会执行一条线程中的指令。为了使得每个线程都在线程切换后能够恢复在切换之前的程序执行位置，每个线程都需要有自己独立的程序计数器，并且不能互相被干扰，否则就会影响到程序的正常执行次序。因此，程序计数器是每个线程所私有的。</p><ul><li>如果程序执行的是一个 Java 方法，则计数器记录的是正在执行的虚拟机字节码指令地址；</li><li>如果正在执行的是一个本地（native，由 C 语言编写完成）方法，则计数器的值为 Undefined。</li></ul><p>由于程序计数器只是记录当前指令地址，所以不存在内存溢出的情况，因此程序计数器也是所有 JVM 内存区域中唯一一个没有定义 OutOfMemoryError 的区域。</p><h2 id="虚拟机栈（JVM-Stack）"><a href="#虚拟机栈（JVM-Stack）" class="headerlink" title="虚拟机栈（JVM Stack）"></a>虚拟机栈（JVM Stack）</h2><blockquote><p>虚拟机栈是 Java 方法执行的内存模型</p></blockquote><p>当线程执行一个方法时，就会创建一个相应的栈帧（Statck Frame），并将建立的栈帧压栈，当方法执行完后，便会将栈帧出栈。</p><p>栈帧中存储了局部变量表（Local Variables）、操作数栈（Operand Stack）、动态链接、方法返回地址（Return Address）等。</p><p><img src="/2018/07/24/zh/programing/java/jvm/%E6%A0%88%E5%B8%A7.png" alt="栈帧" loading="lazy"></p><p>局部变量表中存储着方法的相关局部变量（包括在方法中声明的非静态变量以及函数形参）。基本类型中只有 long 和 double 类型会占用2个局部变量空间（Slot，对于32位机器，1 Slot &#x3D; 32 bit），其它都是1个局部变量空间。</p><blockquote><p>注：局部变量表在编译时就已确定，方法运行所需要分配的空间在栈帧中是完全确定的，在方法的生命周期内都不会改变。</p></blockquote><p>虚拟机栈中定义了两种异常：</p><ul><li>栈溢出（StatckOverFlowError）：如果线程调用的栈深度大于虚拟机允许的最大深度，则抛出；</li><li>内存溢出（OutOfMemoryError）：多数 JVM 允许动态扩展虚拟机栈的大小，如果线程一直申请栈，直到内存不足，则抛出。</li></ul><p>每个线程对应着一个虚拟机栈，因此虚拟机栈也是线程私有的。</p><h2 id="本地方法栈（Native-Method-Statck）"><a href="#本地方法栈（Native-Method-Statck）" class="headerlink" title="本地方法栈（Native Method Statck）"></a>本地方法栈（Native Method Statck）</h2><p>本地方法栈在作用，运行机制，异常类型等方面都与虚拟机栈相同。</p><p>唯一区别：虚拟机栈用于执行 Java 方法；本地方法栈用于执行本地方法（Native Method）。</p><blockquote><p>在规范中并没有对本地方法栈的具体实现方法以及数据结构作强制规定，虚拟机可以自由实现它。比如 Sun 的 JDK 默认的 HotSpot 虚拟机就直接把本地方法栈与虚拟机栈放在一起使用。</p></blockquote><p>本地方法栈也是线程私有的。</p><h2 id="堆区（Heap）"><a href="#堆区（Heap）" class="headerlink" title="堆区（Heap）"></a>堆区（Heap）</h2><p>堆区是理解 GC 机制最重要的区域。在 JVM 所管理的内存中，堆区最大，是 GC 机制所管理的主要内存区域，堆区由所有线程共享，在虚拟机启动时创建。堆区的存在是为了存储对象实例，原则上讲，所有的对象以及数组都在堆区上分配内存（当然也有栈上直接分配的）。</p><p>根据 JVM 规范，堆内存需要在逻辑上是连续的（在物理上不需要），在实现时，可以是固定大小的，也可以是可扩展的，目前主流的虚拟机都是可扩展的。如果在执行垃圾回收之后，仍然没有足够的内存可分配，也不能进行扩展，将会抛出 OutOfMemoryError:Java heap space 异常。</p><p>堆是被所有线程共享的，在 JVM 中只有一个堆。</p><h2 id="方法区（Method-Area）"><a href="#方法区（Method-Area）" class="headerlink" title="方法区（Method Area）"></a>方法区（Method Area）</h2><p>方法区在 JVM 中也是一个非常重要的区域，它与堆一样，是被线程共享的区域。</p><p>在 JVM 规范中，没有强制要求方法区必须实现垃圾回收。很多人习惯将方法区称为“永久代”，是因为 HotSpot 虚拟机将分代收集的思想扩展到了方法区，并将方法区设计成了永久代，从而 JVM 的垃圾收集器可以像管理堆区一样管理这部分区域。但实际上，方法区并不是堆（Non-Heap），从而不需要专门为这部分设计垃圾回收机制。而自从 JDK7 之后，Hotspot 虚拟机便将运行时常量池从永久代移除了。</p><p>在方法区中，存储了每个类的信息（包括类的名称、方法信息、字段信息）、静态变量、常量以及编译器编译后的代码等。</p><p>在 Class 文件中除了类的字段、方法、接口等描述信息外，还有一项信息是常量池，用来存储编译期间生成的字面量和符号引用。</p><p>在方法区中有一个非常重要的部分就是运行时常量池，它是每一个类或接口的常量池的运行时表示形式，在类和接口被加载到 JVM 后，对应的运行时常量池就被创建出来。</p><blockquote><p>运行时常量池（Runtime Constant Pool）：</p><ul><li>方法区的一部分，用于存储编译期就生成的字面常量、符号引用、翻译出来的直接引用（符号引用就是编码是用字符串表示某个变量、接口的位置，直接引用就是根据符号引用翻译出来的地址，将在类链接阶段完成翻译）；</li><li>运行时常量池除了存储编译期常量外，也可以存储在运行时间产生的常量（比如 String 类的 intern() 方法，作用是 String 维护了一个常量池，如果调用的字符“abc”已经在常量池中，则返回池中的字符串地址，否则，新建一个常量加入池中，并返回地址）。</li></ul></blockquote><p>方法区在物理上不需要连续，可以选择固定大小或可扩展大小，并且方法区比堆还多了一个限制：可以选择是否执行垃圾收集。一般的，方法区上执行的垃圾收集是很少的，这也是方法区被称为永久代的原因之一（HotSpot），但这也不代表着在方法区上完全没有垃圾收集，其上的垃圾收集主要是针对常量池的内存回收和对已加载类的卸载。</p><p>在方法区上进行垃圾收集，条件苛刻而且相当困难，效果也不令人满意，所以一般不做太多考虑，可以留作以后进一步深入研究时使用。</p><p>方法区定义了 OutOfMemoryError:PermGen space 异常，在内存不足时抛出。</p><h2 id="直接内存（Direct-Memory）"><a href="#直接内存（Direct-Memory）" class="headerlink" title="直接内存（Direct Memory）"></a>直接内存（Direct Memory）</h2><p>直接内存并不是 JVM 管理的内存，是 JVM 以外的机器内存（比如机器有4G内存，JVM 占用了1G，则其余的3G就是直接内存）。</p><p>JDK 中有一种基于通道（Channel）和缓冲区（Buffer）的内存分配方式，将由 C 语言实现的 native 函数库分配在直接内存中，用存储在 JVM 堆中的 DirectByteBuffer 来引用。由于直接内存受本机器内存的限制，所以可能出现 OutOfMemoryError。</p><h1 id="对象的访问方式"><a href="#对象的访问方式" class="headerlink" title="对象的访问方式"></a>对象的访问方式</h1><p>引用访问涉及到 JVM 的三个内存区域：栈，堆，方法区。</p><p>举个栗子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></table></figure><ul><li>obj 表示一个本地引用，存储在 JVM 栈的本地变量表中；</li><li>new 出来的 Object 作为实例对象数据存储在堆中；</li><li>堆中还记录了 Object 类的类型信息（接口、方法、field、对象类型等）的地址，这些地址所执行的数据存储在方法区中。</li></ul><p>在 JVM 规范中，对于通过引用类型引用访问具体对象的方式并未做规定，目前主流的实现方式主要有两种：</p><p><strong>通过句柄访问</strong></p><p><img src="/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E5%8F%A5%E6%9F%84%E8%AE%BF%E9%97%AE.png" alt="通过句柄访问——《深入理解Java虚拟机：JVM高级特效与最佳实现》" loading="lazy"></p><p>通过句柄访问的实现方式中，JVM 堆中会专门有一块区域用来作为句柄池，存储相关句柄所执行的实例数据地址（包括在堆中地址和在方法区中的地址）。这种实现方法由于用句柄表示地址，因此十分稳定。</p><p><strong>通过直接指针访问</strong></p><p><img src="/2018/07/24/zh/programing/java/jvm/%E9%80%9A%E8%BF%87%E7%9B%B4%E6%8E%A5%E6%8C%87%E9%92%88%E8%AE%BF%E9%97%AE.png" alt="通过直接指针访问——《深入理解Java虚拟机：JVM高级特效与最佳实现》" loading="lazy"></p><p>通过直接指针访问的方式中，引用中存储的就是对象在堆中的实际地址，在堆中存储的对象信息中包含了在方法区中的相应类型数据。这种方法最大的优势是速度快，在 HotSpot 虚拟机中用的就是这种方式。</p><h1 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h1><p>常见的错误提示：</p><ul><li>tomcat:java.lang.OutOfMemoryError:PermGen space</li><li>tomcat:java.lang.OutOfMemoryError:Java heap space</li><li>java:java.lang.OutOfMemoryError</li></ul><p>导致 OutOfMemoryError 异常的常见原因：</p><ul><li>内存中加载的数据量过于庞大，如一次从数据库取出过多数据</li><li>集合类中有对对象的引用，使用完后未清空，使得 JVM 不能回收</li><li>代码中存在死循环或循环产生过多重复的对象实体</li><li>使用的第三方软件中的BUG</li><li>启动参数内存值设定过小</li></ul><p><strong>java.lang.OutOfMemoryError</strong></p><p>增加 JVM 内存大小：</p><ul><li>在执行某个 Class 文件时，设置 -Xmx256M 所允许占用的最大内存为256M。</li><li>对 Tomcat 容器，可以在启动时设置内存限度。在 catalina.bat 中添加：<br>set CATALINA_OPTS&#x3D;-Xms128M -Xmx256M<br>set JAVA_OPTS&#x3D;-Xms128M -Xmx256M</li></ul><p>其中 -Xms128M 为最小内存，-Xmx256M 为最大内存。</p><p>优化程序：</p><ul><li>检查代码中是否有死循环或递归调用。</li><li>检查是否有大循环重复产生新对象实体。</li><li>检查对数据库查询中，是否有一次获得全部数据的查询。一般来说，如果一次取十万条记录到内存，就可能引起内存溢出。这个问题比较隐蔽，在上线前，数据库中数据较少，不容易出问题，上线后，数据库中数据多了，一次查询就有可能引起内存溢出。因此对于数据库查询尽量采用分页的方式查询。</li><li>检查 List、Map 等集合对象是否有使用完后，未清除的问题。List、Map 等集合对象会始终存有对对象的引用，使得这些对象不能被 GC 回收。</li></ul><p>主要包括避免死循环，应该及时释放种资源：内存, 数据库的各种连接，防止一次载入太多的数据。导致的根本原因是程序不健壮。因此，从根本上解决Java内存溢出的唯一方法就是修改程序，及时地释放没用的对象，释放内存空间。 遇到该错误的时候要仔细检查程序，嘿嘿，遇多一次这种问题之后，以后写程序就会小心多了。</p><p><strong>tomcat:java.lang.OutOfMemoryError:PermGen space</strong></p><p>PermGen space：内存的永久保存区域（Permanent Generation space），这块内存主要是被 JVM 存放 Class 和 Meta 信息,Class 在被 Loader 时就会被放到 PermGen space 中, 它和存放类实例（Instance）的 Heap 堆区不同，GC 不会在主程序运行期对 PermGen space 进行清理，所以如果应用中有很多 Class 的话,就很可能出现 PermGen space 错误, 这种错误常见在 Web 服务器对 JSP 进行 pre compile 的时候。如果 Web APP 下都用了大量的第三方jar, 其大小超过了 JVM 默认的大小（4M）那么就会产生此错误信息了。</p><p>解决：修改 TOMCAT_HOME&#x2F;bin&#x2F;catalina.sh 的 MaxPermSize 大小：</p><p>echo “Using CATALINA_BASE: $CATALINA_BASE”</p><p>在上面加入：<code>JAVA_OPTS=&quot;-server -XX:PermSize=64M -XX:MaxPermSize=128m</code></p><p>建议：将相同的第三方 jar 文件移置到 tomcat&#x2F;shared&#x2F;lib 目录，减少 jar 文档重复占用内存。</p><h1 id="内存泄漏排查"><a href="#内存泄漏排查" class="headerlink" title="内存泄漏排查"></a>内存泄漏排查</h1></div><div class="article-licensing box"><div class="licensing-title"><p>JVM</p><p><a href="https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/">https://zoctan.github.io/2018/07/24/zh/programing/java/jvm/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Zoctan</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2018-07-24</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-10-22</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-634fc88092b0a58a" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/img/pay_ali.jpg" alt="Alipay"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/img/pay_wechat.jpg" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/07/25/zh/programing/java/spring/request_and_its_thread_safety_analysis/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">获取 request 及其线程安全性分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/07/22/zh/programing/design_ideas/download_waiting/"><span class="level-item">下载等待</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="Zoctan"></figure><p class="title is-size-4 is-block" style="line-height:inherit">Zoctan</p><p class="is-size-6 is-block">Full Stack Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">144</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">8</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zoctan" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zoctan"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:zoctan@163.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="https://zoctan.github.io/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">38</span></span></a></li><li><a class="level is-mobile" href="/categories/book-read/"><span class="level-start"><span class="level-item">book read</span></span><span class="level-end"><span class="level-item tag">30</span></span></a><ul><li><a class="level is-mobile" href="/categories/book-read/algorithms/"><span class="level-start"><span class="level-item">algorithms</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/book-read/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/book-read/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/zh/"><span class="level-start"><span class="level-item">zh</span></span><span class="level-end"><span class="level-item tag">15</span></span></a><ul><li><a class="level is-mobile" href="/categories/zh/basis/"><span class="level-start"><span class="level-item">basis</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/zh/hardware/"><span class="level-start"><span class="level-item">hardware</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/zh/hardware/raspberry/"><span class="level-start"><span class="level-item">raspberry</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/zh/usage/"><span class="level-start"><span class="level-item">usage</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/zh/work/"><span class="level-start"><span class="level-item">work</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E6%8B%9C%E8%AF%BB/"><span class="level-start"><span class="level-item">拜读</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">数据结构</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2022-10-11T16:00:00.000Z">2022-10-12</time></p><p class="title"><a href="/2022/10/12/zh/usage/v2ray_cloudfare_save_bang_ip/">V2ray + Cloudfare 拯救被墙 VPS IP</a></p><p class="categories"><a href="/categories/zh/">zh</a> / <a href="/categories/zh/usage/">usage</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-01-30T16:00:00.000Z">2019-01-31</time></p><p class="title"><a href="/2019/01/31/zh/programing/docker/jenkins_auto_deploy/">Jenkins 自动化部署</a></p><p class="categories"><a href="/categories/Docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-01-28T16:00:00.000Z">2019-01-29</time></p><p class="title"><a href="/2019/01/29/zh/programing/docker/gitlab_deploy/">GitLab 搭建</a></p><p class="categories"><a href="/categories/Docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-01-28T16:00:00.000Z">2019-01-29</time></p><p class="title"><a href="/2019/01/29/zh/programing/docker/registry_deploy/">Registry 搭建</a></p><p class="categories"><a href="/categories/Docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2018-10-30T16:00:00.000Z">2018-10-31</time></p><p class="title"><a href="/2018/10/31/zh/programing/design_ideas/short_link_service_system/">短链接服务系统开发</a></p><p class="categories"><a href="/categories/%E6%8B%9C%E8%AF%BB/">拜读</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">October 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">July 2018</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">May 2018</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">49</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/MyBatis/"><span class="tag">MyBatis</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OAuth2/"><span class="tag">OAuth2</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSO/"><span class="tag">SSO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring Cloud</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%91/"><span class="tag">树</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81/"><span class="tag">源码</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3229148200516708" data-ad-slot="9728616636" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Zoctan&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Zoctan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",function(){loadInsight({contentUrl:"/content.json"},{hint:"Type something...",untitled:"(Untitled)",posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags"})})</script></body></html>